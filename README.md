# Индивидуальный дипломный проект курса «Go-разработчик»

## Абстрактная схема взаимодействия с системой
Данная работа выполнена студентом курса "Go-разработчик" Имековым Владимиром на платформе Яндекс.Практикум

## Общие требования
Система представляет собой HTTP API со следующими требованиями к бизнес-логике:

    · регистрация, аутентификация и авторизация пользователей;
    · приём номеров заказов от зарегистрированных пользователей;
    · учёт и ведение списка переданных номеров заказов зарегистрированного пользователя;
    · учёт и ведение накопительного счёта зарегистрированного пользователя;
    · проверка принятых номеров заказов через систему расчёта баллов лояльности;
    · начисление за каждый подходящий номер заказа положенного вознаграждения на счёт лояльности пользователя.

## Используемые таблицы

users

| user_ID  |     Login     |            password            |
|----------|:-------------:|:------------------------------:|
|  349379  |  user123	   |f0fda58630310a6dd91a7d8f0a4ceda2| 


orders

|    order     |     User_ID   | status  |            date          |    accrual    |
|:------------:|:-------------:|:-------:|:------------------------:|:-------------:|
|  9278923470  |      876548   |   3     | 2020-12-10T15:15:45+03:00|       500     |


withdrawals

|    order     |     User_ID   |   sum   |            date          |
|:------------:|:-------------:|:-------:|:------------------------:|
|  9278923470  |     876548	   |   1500  | 2020-12-10T15:15:45+03:00|


current_balances

|     User_ID   |   accrual_total   |      withdrawal_total       |
|:-------------:|:-----------------:|:---------------------------:|
|     876548	|         8900      |              400            |


statuses

|    id   |     status   |
|:-------:|:------------:|
|    1    |      NEW     | 


## Описание алгоритмов работы хэндеров

### POST /api/user/orders — загрузка пользователем номера заказа для расчёта;
    · проверяем поля полученного запроса, в случае отсутствия необходимых полей возвращаем 400
    · проверяем айди пользователя и номер заказа в таблице orders, если уже есть такая запись, то возвращаем 200
    · проверяем номер заказа в таблице orders, если этот заказ загружен другим пользователем, то возвращаем 409
    · проверяем номер заказа алгоритмом луна, в случае неправильного формата возвращаем статус 422
    · вставка записи в таблицу orders, где status = new, accrual = 0

### GET /api/user/orders — получение списка загруженных пользователем номеров заказов, статусов их обработки и информации о начислениях;
    · запрос из таблицы orders, where user_id = <current_user>

### GET /api/user/balance — получение текущего баланса счёта баллов лояльности пользователя;
    · запрос из таблиц orders и debits
    · вывод sum(orders.accrual)-sum(debits.sum) и sum(debits.sum)

### POST /api/user/balance/withdraw — запрос на списание баллов с накопительного счёта в счёт оплаты нового заказа;
    · проверяем номер заказа алгоритмом луна, в случае неправильного формата возвращаем статус 422
    · запрос из таблиц orders и debits
    · sum(orders.accrual)-sum(debits.sum)  сравнить с запрашиваемой суммой из POST-запроса
    · если не хватает баллов, то возвращаем статус 402
    · если баллов хватает, то делаем вставку в таблицу debits

### GET /api/user/withdrawals — получение информации о выводе средств с накопительного счёта пользователем.
    · запрос из таблицы debits, возвращаем 200 и список списаний
    · если записей нет, то возвращаем просто статус 204
